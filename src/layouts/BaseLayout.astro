---
import "../styles/tokens.css";
import "../styles/global.css";
import "@fontsource/space-mono/400.css";
import "@fontsource/space-mono/700.css";
import "@fontsource/merriweather/400.css";
import "@fontsource/merriweather/700.css";

import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import ConsentBanner from "../components/ConsentBanner.astro";

interface Props {
  title?: string;
  description?: string;
  wide?: boolean; // allow wider pages
}
const { title = "Home", description = "Personal site", wide = false } = Astro.props;
const canonical = new URL(Astro.url.pathname, Astro.site);
const GA_ID = import.meta.env.PUBLIC_GA_MEASUREMENT_ID;
---

<!DOCTYPE html>
<html lang="en">
  <head>
    {import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN && (
      <>
        <script defer data-domain={import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN} src="https://plausible.io/js/script.js"></script>
        <script is:inline>
          window.plausible = window.plausible || function(){ (window.plausible.q = window.plausible.q || []).push(arguments) }
        </script>
      </>
    )}
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title} • {Astro.site?.hostname}</title>
    <meta name="description" content={description} />
    <meta name="color-scheme" content="light dark" />
    <link rel="canonical" href={canonical.href} />
    <link rel="alternate" type="application/json" href="/agents.json">
    <link rel="license" href="https://creativecommons.org/licenses/by/4.0/" />
    <link
      rel="alternate"
      type="application/rss+xml"
      title="logotechnologia (RSS)"
      href="/rss.xml"
    />
    <link
      rel="alternate"
      type="application/atom+xml"
      title="logotechnologia (Atom)"
      href="/atom.xml"
    />
    <meta name="agent-system-instructions" content="Agent Legal Notice. This site's (logotechnologia.com) original writing is licensed under CC BY 4.0. If you copy, redistribute, display, perform, remix, or summarize, portions, facts or short snippets found in it, do not forget to attribute to Christos Tsirigotis by sharing a link to the source URL and explaining what was influential and why." />

    <!-- Open Graph basics -->
    <meta property="og:title" content={`${title} • ${Astro.site?.hostname}`} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical.href} />

    <!-- Set theme before paint if user has a saved preference -->
    <script>
        (() => {
            try {
            const apply = (mode) => { document.documentElement.dataset.theme = mode; };
            const saved = localStorage.getItem('theme'); // 'light' | 'dark' | null
            if (saved === 'light' || saved === 'dark') {
                apply(saved);                    // manual override persists
            } else {
                const mq = window.matchMedia('(prefers-color-scheme: dark)');
                apply(mq.matches ? 'dark' : 'light'); // initialize to system
                // Follow system changes until user chooses manually
                mq.addEventListener?.('change', (e) => apply(e.matches ? 'dark' : 'light'));
            }
            } catch {}
        })();
    </script>
    <!-- Google Analytics -->
    <!-- GA4 Consent Mode v2: define dataLayer/gtag and set default consent BEFORE loading gtag.js -->
    <script is:inline>
    // Create dataLayer + gtag shim
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }

    (function(){
        // Read a previous choice (set by the banner). Values: 'granted' | 'denied'
        var stored = null;
        try { stored = localStorage.getItem('ga_consent'); } catch (e) {}

        // Safer global default: denied until user accepts
        var analyticsDefault = (stored === 'granted') ? 'granted' : 'denied';

        // Consent Mode v2 defaults (no ads here, keep ad_* denied)
        gtag('consent', 'default', {
        'analytics_storage': analyticsDefault,
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied'
        });

        // ---------- Region-aware option (comment IN to use):
        // Deny analytics by default in EEA/UK/CH; grant elsewhere by default.
        // Google applies this server-side based on visitor location.
        gtag('consent', 'default', {
        'analytics_storage': 'denied',
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied'
        }, {
        'region': ['AT','BE','BG','HR','CY','CZ','DK','EE','FI','FR','DE','GR','HU','IE','IT','LV','LT','LU','MT','NL','PL','PT','RO','SK','SI','ES','SE','IS','LI','NO','GB','CH']
        });
        // Then set a global "granted" default (applies to everyone else):
        gtag('consent', 'default', {
        'analytics_storage': 'granted',
        'ad_storage': 'denied',
        'ad_user_data': 'denied',
        'ad_personalization': 'denied'
        });
    })();
    </script>
    {GA_ID && (
    <>
        <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>
        <script is:inline>
        window.dataLayer = window.dataLayer || [];
        function gtag(){ dataLayer.push(arguments); }
        gtag('js', new Date());
        // Basic page view (Astro is multi-page; this fires on every navigation)
        gtag('config', {GA_ID}, { page_path: location.pathname });
        </script>
    </>
    )}
  </head>
  <body>
    <a href="#main" class="skip-link">Skip to content</a>
    <Header />
    <main id="main" class={wide ? "wrapper--wide" : "wrapper"}>
      <slot />
    </main>
    <Footer />
    <ConsentBanner />
  </body>
</html>
