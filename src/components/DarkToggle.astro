<button class="btn btn--ghost icon-only" id="theme-toggle" type="button"
        aria-label="Toggle dark mode" aria-pressed="false">
  <i class="fa-solid fa-sun"  data-icon="sun"  aria-hidden="true"></i>
  <i class="fa-solid fa-moon" data-icon="moon" aria-hidden="true"></i>
</button>

<style>
  .icon-only{
    width: 36px; height: 36px; display: grid; place-items: center;
    border-radius: 6px;
  }
  .icon-only i{ display: none; line-height:1; font-size: 18px; color: var(--muted); }
  :root:not([data-theme="dark"]) [data-icon="sun"] { display: inline-block; }
  :root[data-theme="dark"]        [data-icon="moon"]{ display: inline-block; }
  .icon-only:hover i { color: var(--ink); }
</style>

<script is:inline>
  (() => {
    const root = document.documentElement;
    const btn  = document.getElementById('theme-toggle');
    const meta = document.getElementById('meta-theme-color');

    const sync = () => {
      const dark = root.dataset.theme === 'dark';
      btn.setAttribute('aria-pressed', dark ? 'true' : 'false');
      btn.setAttribute('aria-label', dark ? 'Switch to light theme' : 'Switch to dark theme');
    };

    const setTheme = (next) => {
      root.dataset.theme = next;
      try { localStorage.setItem('theme', next); } catch {}
      // Smooth fade (removed automatically)
      root.classList.add('theme-anim');
      clearTimeout(window.__themeAnimTimer);
      window.__themeAnimTimer = setTimeout(() => root.classList.remove('theme-anim'), 260);
      // Update browser UI color (if you included it in <head>)
      if (meta) meta.setAttribute('content', next === 'dark' ? '#0F1115' : '#F7F6F3');
      // Notify listeners (Giscus, etc.)
      window.dispatchEvent(new CustomEvent('theme-change', { detail: next }));
      sync();
    };

    btn?.addEventListener('click', () => {
      const next = root.dataset.theme === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });

    // Keep icons/aria synced if something else flips theme
    window.addEventListener?.('astro:after-swap', sync);
    window.matchMedia?.('(prefers-color-scheme: dark)')
      .addEventListener?.('change', () => sync());

    sync();
  })();
</script>
