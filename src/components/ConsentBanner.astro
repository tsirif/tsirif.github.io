<div id="consent-banner" class="consent" role="dialog" aria-live="polite" aria-label="Cookie consent" hidden>
  <div class="consent__inner">
    <p class="consent__text">
      We use Google Analytics to understand how this site is used. You can accept or reject analytics cookies.
    </p>
    <div class="consent__actions">
      <button type="button" class="btn" id="consent-accept">Accept</button>
      <button type="button" class="btn btn--ghost" id="consent-reject">Reject</button>
    </div>
  </div>
</div>

<style>
  .consent {
    position: fixed; inset-inline: 12px; bottom: 12px; z-index: 9999;
    border: 1px solid var(--border); background: var(--paper); color: var(--ink);
    border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,.08);
  }
  .consent__inner { padding: 12px 14px; display: grid; gap: 10px; align-items: center; }
  .consent__text { margin: 0; }
  .consent__actions { display: flex; gap: 8px; }
  @media (min-width: 640px){ .consent__inner { grid-template-columns: 1fr auto; } }
</style>

<script is:inline>
  (function(){
    const KEY = 'ga_consent';
    const el = document.getElementById('consent-banner');
    const accept = document.getElementById('consent-accept');
    const reject = document.getElementById('consent-reject');

    if (!el) return;

    // Show only if no prior choice
    let stored = null;
    try { stored = localStorage.getItem(KEY); } catch(e) {}
    if (!stored) { el.hidden = false; }

    const setConsent = (value) => {
      try { localStorage.setItem(KEY, value); } catch(e) {}
      if (window.gtag) {
        const granted = (value === 'granted');
        window.gtag('consent', 'update', {
          'analytics_storage': granted ? 'granted' : 'denied',
          'ad_storage': 'denied',
          'ad_user_data': 'denied',
          'ad_personalization': 'denied'
        });
      }
      el.hidden = true;
    };

    accept?.addEventListener('click', () => setConsent('granted'));
    reject?.addEventListener('click', () => setConsent('denied'));

    // Close on Escape (does not change stored choice)
    document.addEventListener('keydown', (ev) => {
      if (ev.key === 'Escape' && !el.hidden) {
        el.hidden = true;
      }
    });

    // Expose a safe API to (re)open the banner on demand
    window.openConsentBanner = () => {
      el.hidden = false;
      // Move focus to Accept for quick keyboard/AT interaction
      setTimeout(() => accept?.focus(), 0);
    };

    // Also respond to a custom event
    window.addEventListener('consent-open', () => window.openConsentBanner());
  })();
</script>
