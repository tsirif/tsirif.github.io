---
interface Props {
  entry: any;
  kind: 'project' | 'writing';
}
const { entry, kind } = Astro.props;
const d = entry.data || {};
const slug = entry.slug;

const title = d.title;
const dateISO = d.date ? new Date(d.date).toISOString().slice(0,10) : '';
const venue = kind === 'project' ? d.venue : undefined;

const img = kind === 'project' ? d.images?.teaser : d.image;
const imgAlt = kind === 'project' ? d.images?.alt : d.imageAlt;

const keywords: string[] = d.keywords || [];
const url = kind === 'project' ? `/projects/${slug}/` : `/writing/${slug}/`;

const tldr = d.tldr ?? d.summary ?? '';
const impact = d.impact ?? {};
const links = d.links ?? {};
const authors: string[] = d.authors || [];
---

<article class="card" data-slug={slug}>

  <!-- CHANGE: .card__top will only become 2 columns if it has a *visible* media wrapper -->
  <div class="card__top">
    <div class="card__meta">
      <h3 class="card__title"><a class="link" href={url}>{title}</a></h3>
      <small class="muted">
        <time datetime={dateISO}>{dateISO}</time>{venue ? ` • ${venue}` : ''}
      </small>

      {kind === 'project' && authors.length > 0 && (
        <div class="card__authors">
          <span>By {authors.join(", ")}</span>
        </div>
      )}

      {keywords.length > 0 && (
        <div class="card__tags">
          {keywords.map((t) => (
            <a class="tag" href={`/tags/${String(t).toLowerCase()}/`}>{t}</a>
          ))}
        </div>
      )}

      {(links.code || links.demo || links.paper || links.website || links.explainer || links.x) && (
        <p class="card__links">
          {links.paper && (<a class="link" href={links.paper} rel="noopener noreferrer">Paper</a>)}{links.paper && ' • '}
          {links.code && (<a class="link" href={links.code} rel="noopener noreferrer">Code</a>)}{links.code && ' • '}
          {links.demo && (<a class="link" href={links.demo} rel="noopener noreferrer">Demo</a>)}{links.demo && ' • '}
          {links.website && (<a class="link" href={links.website} rel="noopener noreferrer">Project site</a>)}{links.website && ' • '}
          {links.explainer && (<a class="link" href={links.explainer}>Explainer</a>)}{links.explainer && ' • '}
          {links.x && (<a class="link" href={links.x} rel="noopener noreferrer">X post</a>)}
        </p>
      )}
    </div>

    {img && (
      <!-- CHANGE: wrap media so we can hide it on load error -->
      <div class="card__media-wrap">
        <a href={url} aria-label={`Open ${title}`}>
          <img
            class="card__media"
            src={img}
            alt={imgAlt || ''}
            loading="lazy"
            decoding="async"
            width="640"
            height="360"
            sizes="(max-width: 860px) 92vw, 280px"
          />
        </a>
      </div>
    )}
  </div>

  <!-- Actions: visible on touch/mobile; hidden on hover-capable devices -->
  <div class="card__actions">
    <button class="btn btn--ghost small" data-toggle type="button" aria-expanded="false">More</button>
  </div>

  <div class="card__details">
    {tldr && (<p><strong>TL;DR:</strong> {tldr}</p>)}
    {kind === 'project' && (d.status || Object.keys(impact).length > 0) && (
      <p class="muted">
        {d.status ? (<><strong>Status:</strong> {d.status}. </>) : null}
        {impact.citations ? (<><strong>Citations:</strong> {impact.citations}. </>) : null}
        {impact.github_stars ? (<><strong>GitHub stars:</strong> {impact.github_stars}. </>) : null}
        {impact.downloads ? (<><strong>Downloads:</strong> {impact.downloads}. </>) : null}
      </p>
    )}
  </div>

  <style>
    .card { border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; display: grid; gap: 10px; }
    .card__top { display: grid; grid-template-columns: 1fr; gap: 12px; }

    /* CHANGE: two columns only when a *visible* media wrapper exists */
    @media (min-width: 860px) {
      .card__top.has-media { grid-template-columns: 1fr 280px; align-items: start; }
      /* modern browsers: :has fallback to class above; both are fine */
      .card__top:has(.card__media-wrap:not([hidden])) { grid-template-columns: 1fr 280px; align-items: start; }
    }

    .card__media {
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .card__title { margin: 0 0 4px 0; }
    .card__authors { margin-top: 6px; color: var(--muted); font-size: 0.95em; }
    .card__tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .card .tag{ font-size: 0.85em; padding: 2px 8px; border: 1px solid var(--border); border-radius: 999px; }
    .card__links{ margin-top: 6px; font-size: 0.95em; }

    .card__actions { display: flex; justify-content: flex-start; }

    /* DETAILS: collapsed by default; smooth but respectful of reduced motion */
    .card__details {
      margin-top: 8px;
      max-height: 0;
      overflow: clip;
      opacity: 0;
      transition: max-height .25s ease, opacity .2s ease;
    }
    @media (prefers-reduced-motion: reduce) {
      .card__details { transition: none; }
    }

    /* Desktop: reveal on hover/focus; no button */
    @media (hover: hover) and (pointer: fine) {
      .card__actions { display: none; }
      .card:hover .card__details,
      .card:focus-within .card__details {
        max-height: 1000px;
        opacity: 1;
      }
    }

    /* Mobile or explicit open */
    .card.is-open .card__details {
      max-height: 1000px;
      opacity: 1;
    }
  </style>

  <script is:inline>
    (() => {
      const card = document.currentScript?.closest('.card');
      if (!card) return;

      // Mobile toggle
      const btn = card.querySelector('[data-toggle]');
      const details = card.querySelector('.card__details');
      if (btn && details) {
        btn.addEventListener('click', () => {
          const open = card.classList.toggle('is-open');
          btn.setAttribute('aria-expanded', open ? 'true' : 'false');
          btn.textContent = open ? 'Less' : 'More';
        });
      }

      // CHANGE: collapse media column if image never loads
      const top   = card.querySelector('.card__top');
      const wrap  = card.querySelector('.card__media-wrap');
      const imgEl = wrap?.querySelector('img');

      const updateCols = () => {
        if (!top) return;
        const hasMedia = !!(wrap && !wrap.hasAttribute('hidden'));
        top.classList.toggle('has-media', hasMedia); // fallback for browsers without :has
      };

      if (imgEl) {
        // If browser already tried loading, detect failure immediately
        if (imgEl.complete && imgEl.naturalWidth === 0) {
          wrap.setAttribute('hidden', '');
        }
        imgEl.addEventListener('error', () => { wrap.setAttribute('hidden', ''); updateCols(); });
        imgEl.addEventListener('load',  () => { wrap.removeAttribute('hidden'); updateCols(); });
      }
      updateCols();
    })();
  </script>
</article>
