---
const repo       = import.meta.env.PUBLIC_GISCUS_REPO;
const repoId     = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const category   = import.meta.env.PUBLIC_GISCUS_CATEGORY;
const categoryId = import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;

// Pick the pair you like; these match your palette well:
const lightTheme = 'light';             // GitHub Light
const darkTheme  = 'transparent_dark';  // Transparent Dark
---

{(repo && repoId && category && categoryId) ? (
  <>
    <script
      src="https://giscus.app/client.js"
      data-repo={repo}
      data-repo-id={repoId}
      data-category={category}
      data-category-id={categoryId}
      data-mapping="pathname"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-theme="preferred_color_scheme"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
    <noscript><em>Enable JavaScript to view comments powered by Giscus.</em></noscript>

    <!-- Align Giscus theme to site theme on load and on toggle -->
    <script is:inline>
      (() => {
        const setTheme = (mode) => {
          const theme = (mode === 'dark') ? {JSON.stringify(darkTheme)} : {JSON.stringify(lightTheme)};
          const iframe = document.querySelector('iframe.giscus-frame');
          iframe?.contentWindow?.postMessage({ giscus: { setConfig: { theme } } }, 'https://giscus.app');
        };

        // Once the iframe is present, sync to the site's current theme
        const syncOnce = () => setTheme(document.documentElement.dataset.theme === 'dark' ? 'dark' : 'light');
        const obs = new MutationObserver(() => {
          if (document.querySelector('iframe.giscus-frame')) {
            syncOnce();
            obs.disconnect();
          }
        });
        obs.observe(document.body, { childList: true, subtree: true });

        // Keep syncing when your footer toggle fires the event
        window.addEventListener('theme-change', (e) => setTheme(e.detail));
      })();
    </script>
  </>
) : (
  <p class="muted">Comments are not configured yet.</p>
)}
