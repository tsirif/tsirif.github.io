---
const repo      = import.meta.env.PUBLIC_GISCUS_REPO;
const repoId    = import.meta.env.PUBLIC_GISCUS_REPO_ID;
const category  = import.meta.env.PUBLIC_GISCUS_CATEGORY;
const categoryId= import.meta.env.PUBLIC_GISCUS_CATEGORY_ID;

// Initial theme from document on mount (fallback to 'preferred_color_scheme')
const initialTheme = "preferred_color_scheme";
---

{repo && repoId && category && categoryId ? (
  <>
    <script
      src="https://giscus.app/client.js"
      data-repo={repo}
      data-repo-id={repoId}
      data-category={category}
      data-category-id={categoryId}
      data-mapping="pathname"
      data-reactions-enabled="1"
      data-emit-metadata="0"
      data-theme={initialTheme}
      data-input-position="top"
      data-loading="lazy"
      data-lang="en"
      crossorigin="anonymous"
      async>
    </script>
    <noscript><em>Enable JavaScript to view comments powered by Giscus.</em></noscript>
    <script is:inline>
      // Sync Giscus theme to site theme when user toggles
      (function(){
        const sendTheme = (mode) => {
          const theme = (mode === 'dark') ? 'dark_protanopia' : 'light_protanopia';
          const iframe = document.querySelector('iframe.giscus-frame');
          iframe?.contentWindow?.postMessage({ giscus: { setConfig: { theme } } }, 'https://giscus.app');
        };
        // On initial hydration, align with current site theme
        sendTheme(document.documentElement.dataset.theme);

        // Listen to our site-level theme event from the DarkToggle
        window.addEventListener('theme-change', (e) => sendTheme(e.detail));
      })();
    </script>
  </>
) : (
  <p class="muted">Comments are not configured yet.</p>
)}
